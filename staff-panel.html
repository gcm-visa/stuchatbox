<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Staff Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f0fdf0; margin: 0; padding: 20px; }

    #login-section, #chat-section {
      max-width: 600px;
      margin: auto;
      background: white;
      border: 1px solid #cce5cc;
      padding: 20px;
      border-radius: 12px;
    }

    h2 { color: #28a745; text-align: center; }

    input[type="email"], input[type="password"], input[type="text"] {
      width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 8px;
      border: 1px solid #bde5bd;
    }

    button {
      width: 100%; padding: 12px; background-color: #28a745; color: white;
      border: none; border-radius: 8px; font-size: 16px; cursor: pointer;
    }

    #chat-messages {
      max-height: 300px; overflow-y: auto; border: 1px solid #e0f0e0;
      padding: 10px; background: #f6fdf6; margin-bottom: 12px;
    }

    #chat-messages div { margin-bottom: 6px; }

    #chat-form {
      display: flex;
      gap: 10px;
    }

    #chat-form input {
      flex: 1; padding: 10px; border-radius: 8px;
      border: 1px solid #bde5bd;
    }
  </style>
</head>
<body>

<div id="login-section">
  <h2>Staff Login</h2>
  <input type="email" id="staff-email" placeholder="Email" />
  <input type="password" id="staff-password" placeholder="Password" />
  <button onclick="login()">Login</button>
  <p id="login-error" style="color: red;"></p>
</div>

<div id="chat-section" style="display:none;">
  <h2>Chat Dashboard</h2>
  <div id="chat-messages"></div>
  <form id="chat-form">
    <input type="text" id="staff-input" placeholder="Reply..." />
    <button type="submit">Send</button>
  </form>
</div>

<script>
  const SUPABASE_URL = 'https://oxthfocwsqttrzbdjzoj.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94dGhmb2N3c3F0dHJ6YmRqem9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ3OTY5MjMsImV4cCI6MjA2MDM3MjkyM30.nytOvmjM5PNQO8BHeXOTIP_sMullS2PFB8tm5dihlNY';
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let staffName = "";

  async function login() {
    const email = document.getElementById("staff-email").value;
    const password = document.getElementById("staff-password").value;
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });

    if (error) {
      document.getElementById("login-error").textContent = error.message;
    } else {
      document.getElementById("login-section").style.display = "none";
      document.getElementById("chat-section").style.display = "block";
      staffName = email;
      loadMessages();
      subscribeToMessages();
    }
  }

  function addMessageToUI(msg) {
    const div = document.createElement("div");
    div.textContent = `${msg.sender_type === 'staff' ? 'ðŸ‘©â€ðŸ’¼ Staff' : msg.user_name}: ${msg.message}`;
    document.getElementById("chat-messages").appendChild(div);
  }

  async function loadMessages() {
    const { data } = await supabase
      .from("chat_messages")
      .select("*")
      .order("created_at", { ascending: true });
    document.getElementById("chat-messages").innerHTML = "";
    data.forEach(addMessageToUI);
  }

  function subscribeToMessages() {
    supabase
      .channel("chatroom")
      .on("postgres_changes", { event: "*", schema: "public", table: "chat_messages" }, (payload) => {
        addMessageToUI(payload.new);
      })
      .subscribe();
  }

  document.getElementById("chat-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const input = document.getElementById("staff-input");
    const message = input.value.trim();
    if (!message) return;

    await supabase.from("chat_messages").insert([
      { user_name: null, staff_name: staffName, sender_type: "staff", message: message }
    ]);

    input.value = "";
  });
</script>

</body>
</html>
